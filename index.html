<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ユーザーログイン & ファイルアップローダー</title>
</head>
<body>
    <h1>GitHub Pages のファイルを GoFile.io にアップロード</h1>

    <h2>ユーザー認証</h2>
    <input type="text" id="username" placeholder="ユーザー名">
    <input type="password" id="password" placeholder="パスワード">
    <button onclick="register()">新規登録</button>
    <button onclick="login()">ログイン</button>
    <p id="authStatus"></p>

    <h2>アップロード</h2>
    <input type="text" id="fileUrl" value="https://soramame72-storage.github.io/sample.jpg" size="50">
    <button onclick="startUpload()">アップロード開始</button>
    <p id="status"></p>

    <h2>アップロード済みファイル</h2>
    <ul id="fileList"></ul>

    <script type="module">
        // Firebase SDK 読み込み
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase 設定
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Firebase 初期化
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore();

        // ユーザー登録
        async function register() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, username + "@example.com", password);
                const user = userCredential.user;
                await setDoc(doc(db, "users", user.uid), { username, files: [] });
                document.getElementById("authStatus").innerText = "登録完了！";
            } catch (error) {
                document.getElementById("authStatus").innerText = "エラー: " + error.message;
            }
        }

        // ログイン
        async function login() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            try {
                const userCredential = await signInWithEmailAndPassword(auth, username + "@example.com", password);
                document.getElementById("authStatus").innerText = "ログイン成功！";
                loadUserFiles(userCredential.user.uid);
            } catch (error) {
                document.getElementById("authStatus").innerText = "エラー: " + error.message;
            }
        }

        // ユーザーごとのファイルを読み込む
        async function loadUserFiles(userId) {
            const userDoc = await getDoc(doc(db, "users", userId));
            if (userDoc.exists()) {
                const files = userDoc.data().files;
                const fileList = document.getElementById("fileList");
                fileList.innerHTML = "";
                files.forEach(file => {
                    const li = document.createElement("li");
                    li.innerHTML = `<a href="${file}" target="_blank">${file}</a>`;
                    fileList.appendChild(li);
                });
            }
        }

        // ファイルを GoFile.io にアップロード
        async function startUpload() {
            const fileUrl = document.getElementById("fileUrl").value;
            document.getElementById("status").innerText = "アップロード中...";

            try {
                const response = await fetch(fileUrl);
                const blob = await response.blob();
                const formData = new FormData();
                formData.append("file", blob, "uploaded_file.jpg");

                const serverRes = await fetch("https://api.gofile.io/getServer");
                const { data } = await serverRes.json();
                const uploadUrl = `https://${data.server}.gofile.io/uploadFile`;

                const goFileResponse = await fetch(uploadUrl, { method: "POST", body: formData });
                const result = await goFileResponse.json();

                if (result.status === "ok") {
                    const user = auth.currentUser;
                    if (user) {
                        await updateDoc(doc(db, "users", user.uid), {
                            files: arrayUnion(result.data.downloadPage)
                        });
                        loadUserFiles(user.uid);
                    }
                    document.getElementById("status").innerHTML = `アップロード完了！<br><a href="${result.data.downloadPage}" target="_blank">ダウンロードリンク</a>`;
                } else {
                    document.getElementById("status").innerText = "アップロード失敗";
                }
            } catch (error) {
                document.getElementById("status").innerText = "エラーが発生しました";
            }
        }

        // ログイン状態の監視
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadUserFiles(user.uid);
            }
        });

    </script>
</body>
</html>
