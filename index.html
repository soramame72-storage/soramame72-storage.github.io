<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ストレージ</title>
</head>
<body>
    <h1>ストレージ</h1>

    <!-- ログインフォーム -->
    <div id="loginArea">
        <h2>ログイン</h2>
        <input type="email" id="email" placeholder="メールアドレス">
        <input type="password" id="password" placeholder="パスワード">
        <button id="loginButton">ログイン</button>
        <button id="signUpButton">アカウント作成</button>
    </div>

    <!-- アップロード機能 -->
    <div id="storageArea" style="display:none;">
        <h2>ファイルアップロード</h2>
        <input type="file" id="fileInput">
        <button onclick="uploadFile()">アップロード</button>
        <button onclick="logout()">ログアウト</button>

        <h2>ダウンロード</h2>
        <input type="text" id="fileName" placeholder="ファイル名を入力">
        <button onclick="getFileURL()">ダウンロード</button>

        <ul id="fileList"></ul>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, listAll } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-storage.js";

        // Firebase 設定
        const firebaseConfig = {
            apiKey: "AIzaSyAwJKhjvzTOPqPOavrrpInIV1epb4W2Eoo",
            authDomain: "soramame72-storage.firebaseapp.com",
            projectId: "soramame72-storage",
            storageBucket: "soramame72-storage.appspot.com",
            messagingSenderId: "176925134959",
            appId: "176925134959:web:505c741b0c67b0e49d3d9a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // ユーザーのログイン状態を監視
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById("loginArea").style.display = "none";
                document.getElementById("storageArea").style.display = "block";
                loadFileList();
            } else {
                document.getElementById("loginArea").style.display = "block";
                document.getElementById("storageArea").style.display = "none";
            }
        });

        // アカウント作成
        document.getElementById("signUpButton").addEventListener("click", signUp);

        // ログイン
        document.getElementById("loginButton").addEventListener("click", login);

        // アカウント作成処理
        function signUp() {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            createUserWithEmailAndPassword(auth, email, password)
                .then(() => alert("アカウント作成完了！"))
                .catch(error => alert("エラー: " + error.message));
        }

        // ログイン処理
        function login() {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            signInWithEmailAndPassword(auth, email, password)
                .then(() => alert("ログイン成功！"))
                .catch(error => alert("ログイン失敗: " + error.message));
        }

        // ログアウト
        function logout() {
            signOut(auth).then(() => alert("ログアウトしました！"));
        }

        // ファイルアップロード
        function uploadFile() {
            const file = document.getElementById("fileInput").files[0];
            if (!file) return alert("ファイルを選択してください");

            const user = auth.currentUser;
            if (!user) return alert("ログインしてください");

            const storageRef = ref(storage, `uploads/${user.uid}/${file.name}`);
            uploadBytes(storageRef, file).then(() => {
                alert("アップロード完了！");
                loadFileList();
            }).catch(error => alert("アップロードエラー: " + error.message));
        }

        // ファイルリスト取得
        function loadFileList() {
            const user = auth.currentUser;
            if (!user) return;

            const listRef = ref(storage, `uploads/${user.uid}`);
            listAll(listRef).then(res => {
                const fileList = document.getElementById("fileList");
                fileList.innerHTML = "";
                res.items.forEach(fileRef => {
                    fileRef.fullPath;
                    getDownloadURL(fileRef).then(url => {
                        const li = document.createElement("li");
                        li.innerHTML = `<a href="${url}" target="_blank">${fileRef.name}</a>`;
                        fileList.appendChild(li);
                    });
                });
            }).catch(error => alert("ファイル取得エラー: " + error.message));
        }

        // ファイルURL取得
        function getFileURL() {
            const fileName = document.getElementById("fileName").value.trim();
            if (!fileName) return alert("ファイル名を入力してください");

            const user = auth.currentUser;
            if (!user) return alert("ログインしてください");

            const fileRef = ref(storage, `uploads/${user.uid}/${fileName}`);
            getDownloadURL(fileRef).then(url => {
                window.open(url, "_blank");
            }).catch(error => alert("ファイルが見つかりません: " + error.message));
        }
    </script>
</body>
</html>
