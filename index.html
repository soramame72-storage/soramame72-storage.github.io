<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ストレージ</title>
    <style>
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>ストレージ</h1>
    
    <div id="loginForm">
        <h2>ログイン</h2>
        <input type="text" id="loginUsername" placeholder="ユーザー名" required><br>
        <input type="password" id="loginPassword" placeholder="パスワード" required><br>
        <button id="loginButton">ログイン</button>
        <button id="createAccountButton">アカウント作成</button>
    </div>

    <div id="createAccountForm" class="hidden">
        <h2>アカウント作成</h2>
        <input type="text" id="createUsername" placeholder="新しいユーザー名" required><br>
        <input type="password" id="createPassword" placeholder="新しいパスワード" required><br>
        <button id="createAccountButtonAction">アカウント作成</button>
        <button id="backToLoginButton">戻る</button>
    </div>

    <div id="uploadArea" class="hidden">
        <h2>ファイルアップロード</h2>
        <input type="file" id="fileInput"><br>
        <input type="text" id="shareWith" placeholder="共有先のユーザー名 (カンマ区切り)"><br>
        <button onclick="uploadFile()">アップロード</button>
        <button id="logoutButton">ログアウト</button>
        
        <h2>自分のファイル</h2>
        <ul id="fileList"></ul>

        <h2>共有されたファイル</h2>
        <ul id="sharedFileList"></ul>
    </div>

    <script>
        let db;
        let currentUser = null;

        document.addEventListener("DOMContentLoaded", () => {
            const dbRequest = indexedDB.open("CloudStorageDB", 1);

            dbRequest.onupgradeneeded = event => {
                db = event.target.result;
                if (!db.objectStoreNames.contains("users")) {
                    db.createObjectStore("users", { keyPath: "username" });
                }
                if (!db.objectStoreNames.contains("files")) {
                    db.createObjectStore("files", { keyPath: "name" });
                }
            };

            dbRequest.onsuccess = event => {
                db = event.target.result;
            };

            document.getElementById("loginButton").addEventListener("click", login);
            document.getElementById("createAccountButton").addEventListener("click", () => {
                toggleVisibility("createAccountForm", true);
                toggleVisibility("loginForm", false);
            });
            document.getElementById("createAccountButtonAction").addEventListener("click", createAccount);
            document.getElementById("backToLoginButton").addEventListener("click", () => {
                toggleVisibility("loginForm", true);
                toggleVisibility("createAccountForm", false);
            });
            document.getElementById("logoutButton").addEventListener("click", logout);
        });

        function toggleVisibility(elementId, isVisible) {
            document.getElementById(elementId).classList.toggle("hidden", !isVisible);
        }

        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest("SHA-256", data);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, "0")).join("");
        }

        async function createAccount() {
            const username = document.getElementById("createUsername").value.trim();
            const password = await hashPassword(document.getElementById("createPassword").value.trim());

            const transaction = db.transaction(["users"], "readwrite");
            const store = transaction.objectStore("users");
            store.get(username).onsuccess = event => {
                if (event.target.result) {
                    alert("そのユーザー名は既に使われています");
                } else {
                    store.put({ username, password });
                    alert("アカウントが作成されました");
                    toggleVisibility("loginForm", true);
                    toggleVisibility("createAccountForm", false);
                }
            };
        }

        async function login() {
            const username = document.getElementById("loginUsername").value;
            const password = await hashPassword(document.getElementById("loginPassword").value);

            const transaction = db.transaction(["users"], "readonly");
            const store = transaction.objectStore("users");
            store.get(username).onsuccess = event => {
                if (event.target.result?.password === password) {
                    currentUser = username;
                    toggleVisibility("uploadArea", true);
                    toggleVisibility("loginForm", false);
                    loadFiles();
                } else {
                    alert("ユーザー名またはパスワードが間違っています");
                }
            };
        }

        function uploadFile() {
            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0];
            const shareWith = document.getElementById("shareWith").value.split(",").map(s => s.trim());

            if (!file) {
                alert("ファイルを選択してください");
                return;
            }

            const transaction = db.transaction(["files"], "readwrite");
            const store = transaction.objectStore("files");
            store.get(file.name).onsuccess = event => {
                if (event.target.result) {
                    if (!confirm("同名のファイルが存在します。上書きしますか？")) return;
                }
                
                const reader = new FileReader();
                reader.onload = () => {
                    store.put({ name: file.name, data: reader.result, owner: currentUser, sharedWith: shareWith });
                    alert("ファイルがアップロードされました");
                    loadFiles();
                };
                reader.readAsDataURL(file);
            };
        }

        function logout() {
            currentUser = null;
            toggleVisibility("uploadArea", false);
            toggleVisibility("loginForm", true);
        }
    </script>
</body>
</html>
