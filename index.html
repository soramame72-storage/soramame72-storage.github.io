<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ストレージ</title>
    <style>
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>ストレージ</h1>
    
    <!-- ログインフォーム -->
    <div id="loginForm">
        <h2>ログイン</h2>
        <input type="text" id="loginUsername" placeholder="ユーザー名" required><br>
        <input type="password" id="loginPassword" placeholder="パスワード" required><br>
        <button id="loginButton">ログイン</button>
        <button id="createAccountButton">アカウント作成</button>
    </div>

    <!-- 新規アカウント作成フォーム -->
    <div id="createAccountForm" class="hidden">
        <h2>アカウント作成</h2>
        <input type="text" id="createUsername" placeholder="新しいユーザー名" required><br>
        <input type="password" id="createPassword" placeholder="新しいパスワード" required><br>
        <button id="createAccountButtonAction">アカウント作成</button>
        <button id="backToLoginButton">戻る</button>
    </div>

    <!-- アップロード機能 -->
    <div id="uploadArea" class="hidden">
        <h2>ファイルアップロード</h2>
        <input type="file" id="fileInput"><br>
        <input type="text" id="shareWith" placeholder="共有先のユーザー名 (空欄で自分のみ)"><br>
        <button onclick="uploadFile()">アップロード</button>

        <h2>自分のファイル</h2>
        <ul id="fileList"></ul>

        <h2>共有されたファイル</h2>
        <ul id="sharedFileList"></ul>
    </div>

    <script>
        let db;
        let currentUser = null;

        document.addEventListener("DOMContentLoaded", () => {
            const dbRequest = indexedDB.open("CloudStorageDB", 1);

            dbRequest.onupgradeneeded = event => {
                db = event.target.result;
                if (!db.objectStoreNames.contains("users")) {
                    db.createObjectStore("users", { keyPath: "username" });
                }
                if (!db.objectStoreNames.contains("files")) {
                    db.createObjectStore("files", { keyPath: "name" });
                }
            };

            dbRequest.onsuccess = event => {
                db = event.target.result;
            };

            dbRequest.onerror = event => {
                console.error("IndexedDBの初期化に失敗しました", event.target.error);
                alert("データベースの初期化中に問題が発生しました");
            };

            // イベントリスナー設定
            document.getElementById("loginButton").addEventListener("click", login);
            document.getElementById("createAccountButton").addEventListener("click", () => {
                toggleVisibility("createAccountForm", true);
                toggleVisibility("loginForm", false);
            });
            document.getElementById("createAccountButtonAction").addEventListener("click", createAccount);
            document.getElementById("backToLoginButton").addEventListener("click", () => {
                toggleVisibility("loginForm", true);
                toggleVisibility("createAccountForm", false);
            });
        });

        function toggleVisibility(elementId, isVisible) {
            const element = document.getElementById(elementId);
            element.classList.toggle("hidden", !isVisible);
        }

        function login() {
            const username = document.getElementById("loginUsername").value;
            const password = document.getElementById("loginPassword").value;
            
            const transaction = db.transaction(["users"], "readonly");
            const store = transaction.objectStore("users");
            const request = store.get(username);
            
            request.onsuccess = event => {
                const user = event.target.result;
                if (user && user.password === password) {
                    currentUser = username;
                    toggleVisibility("uploadArea", true);
                    toggleVisibility("loginForm", false);
                    loadFiles();
                } else {
                    alert("ユーザー名またはパスワードが間違っています");
                }
            };

            transaction.onerror = event => {
                console.error("ログイン中にエラーが発生しました", event.target.error);
            };
        }

        function createAccount() {
            const username = document.getElementById("createUsername").value.trim();
            const password = document.getElementById("createPassword").value.trim();

            if (!username || !password) {
                alert("ユーザー名とパスワードを入力してください");
                return;
            }

            const transaction = db.transaction(["users"], "readwrite");
            const store = transaction.objectStore("users");
            const request = store.get(username);

            request.onsuccess = event => {
                const existingUser = event.target.result;
                if (existingUser) {
                    alert("そのユーザー名は既に使われています");
                } else {
                    store.put({ username, password });
                    alert("アカウントが作成されました");
                    toggleVisibility("loginForm", true);
                    toggleVisibility("createAccountForm", false);
                }
            };

            transaction.onerror = event => {
                console.error("アカウント作成中に問題が発生しました", event.target.error);
            };
        }

        function uploadFile() {
            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0];
            const shareWith = document.getElementById("shareWith").value.trim();

            if (!file) {
                alert("ファイルを選択してください");
                return;
            }

            const reader = new FileReader();
            reader.onload = () => {
                const transaction = db.transaction(["files"], "readwrite");
                const store = transaction.objectStore("files");
                store.put({ name: file.name, data: reader.result, owner: currentUser, sharedWith: shareWith });

                transaction.oncomplete = () => {
                    alert("ファイルがアップロードされました");
                    loadFiles();
                };

                transaction.onerror = event => {
                    console.error("ファイルアップロード中にエラーが発生しました", event.target.error);
                };
            };

            reader.readAsDataURL(file);
        }

        function loadFiles() {
            const fileList = document.getElementById("fileList");
            const sharedFileList = document.getElementById("sharedFileList");
            fileList.innerHTML = "";
            sharedFileList.innerHTML = "";

            const transaction = db.transaction(["files"], "readonly");
            const store = transaction.objectStore("files");
            const request = store.openCursor();

            request.onsuccess = event => {
                const cursor = event.target.result;
                if (cursor) {
                    const file = cursor.value;
                    const li = document.createElement("li");

                    if (file.owner === currentUser) {
                        li.innerHTML = `<a href="${file.data}" download="${file.name}">${file.name}</a> 
                                        <button onclick="deleteFile('${file.name}')">削除</button>`;
                        fileList.appendChild(li);
                    } else if (file.sharedWith === currentUser) {
                        li.innerHTML = `<a href="${file.data}" download="${file.name}">${file.name}</a> 
                                        (提供者: ${file.owner})`;
                        sharedFileList.appendChild(li);
                    }
                    cursor.continue();
                }
            };

            transaction.onerror = event => {
                console.error("ファイル読み込み中に問題が発生しました", event.target.error);
            };
        }

        function deleteFile(filename) {
            const transaction = db.transaction(["files"], "readwrite");
            const store = transaction.objectStore("files");
            store.delete(filename);

            transaction.oncomplete = () => {
                alert("ファイルが削除されました");
                loadFiles();
            };

            transaction.onerror = event => {
                console.error("ファイル削除中にエラーが発生しました", event.target.error);
            };
        }
    </script>
</body>
</html>
